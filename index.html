<script>
  const emailInput = document.getElementById("email");
  const list = document.getElementById("email-list");
  const timerText = document.getElementById("refresh-timer");

  // ğŸ”¹ çœŸå®é‚®ç®±åˆ—è¡¨ï¼ˆä½ è‡ªå·±ç»´æŠ¤è¿™ä¸ªï¼‰
  const emailList = [
    "a1xxzz@gmail.com",
    "b2yyzz@gmail.com",
    "c3zztt@gmail.com"
  ];

  let currentIndex = 0;
  let currentEmail = emailList[currentIndex];
  let countdown = 5;

  // âœ… æ›¿æ¢ select å’Œéšæœºé‚®ç®±ç”Ÿæˆé€»è¾‘
  function generateEmail() {
    currentIndex = (currentIndex + 1) % emailList.length;
    currentEmail = emailList[currentIndex];
    emailInput.value = currentEmail;
    fetchInbox(); // åˆ‡æ¢é‚®ç®±æ—¶ç«‹å³åˆ·æ–°
  }

  function copyEmail() {
    navigator.clipboard.writeText(currentEmail);
    alert("é‚®ç®±åœ°å€å·²å¤åˆ¶ï¼š" + currentEmail);
  }

  function formatTime(iso) {
    const date = new Date(iso);
    return date.toLocaleString();
  }

  async function fetchInbox() {
    try {
      // ğŸ“© è°ƒç”¨ä¸åŒé‚®ç®±çš„æ•°æ®æ¥å£
      const emailKey = encodeURIComponent(currentEmail);
      const res = await fetch(`inbox/${emailKey}.json?ts=${Date.now()}`);
      const data = await res.json();
      renderInbox(data.messages || []);
    } catch {
      list.innerHTML = `<div class="p-4 text-gray-500 text-sm">åŠ è½½å¤±è´¥æˆ–è¯¥é‚®ç®±æš‚æ— é‚®ä»¶</div>`;
    }
  }

  function renderInbox(messages) {
    list.innerHTML = "";
    if (!messages.length) {
      list.innerHTML = `<div class="p-4 text-gray-500 text-sm">æš‚æ— é‚®ä»¶</div>`;
      return;
    }

    messages.reverse().forEach(msg => {
      const row = document.createElement("div");
      row.className = "grid grid-cols-3 hover:bg-gray-50";
      row.innerHTML = `
        <div class="table-cell">${msg.from || 'æœªçŸ¥'}</div>
        <div class="table-cell">${msg.subject || 'æ— ä¸»é¢˜'}</div>
        <div class="table-cell">${formatTime(msg.date)}</div>
      `;
      list.appendChild(row);
    });
  }

  function startCountdown() {
    countdown--;
    if (countdown <= 0) {
      fetchInbox();
      countdown = 5;
    }
    timerText.textContent = `æ­£åœ¨æ¥æ”¶é‚®ä»¶ä¸­... ${countdown} ç§’åè‡ªåŠ¨åˆ·æ–°`;
  }

  // åˆå§‹åŒ–
  emailInput.value = currentEmail;
  fetchInbox();
  setInterval(startCountdown, 1000);
</script>
